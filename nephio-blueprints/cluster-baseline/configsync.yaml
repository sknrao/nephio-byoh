#==============================================================================
# FILE 1: configsync.yaml
# Location: nephio-blueprints/cluster-baseline/configsync.yaml
# Purpose: Install ConfigSync on workload cluster
#==============================================================================

# ConfigSync is the GitOps controller that watches git repos and applies
# manifests to the cluster. This file installs all necessary components.

---
# Namespace for ConfigSync
apiVersion: v1
kind: Namespace
metadata:
  name: config-management-system
  labels:
    configmanagement.gke.io/system: "true"

---
# ServiceAccount for ConfigSync reconciler
apiVersion: v1
kind: ServiceAccount
metadata:
  name: root-reconciler
  namespace: config-management-system
  labels:
    configmanagement.gke.io/system: "true"
    configmanagement.gke.io/arch: "csmr"

---
# ClusterRole for ConfigSync (needs cluster-admin to apply any resources)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: root-reconciler
  labels:
    configmanagement.gke.io/system: "true"
    configmanagement.gke.io/arch: "csmr"
rules:
  # Full access to manage all resources
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]
  # Access to non-resource URLs
  - nonResourceURLs: ["*"]
    verbs: ["*"]

---
# ClusterRoleBinding for ConfigSync
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: root-reconciler
  labels:
    configmanagement.gke.io/system: "true"
    configmanagement.gke.io/arch: "csmr"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: root-reconciler
subjects:
  - kind: ServiceAccount
    name: root-reconciler
    namespace: config-management-system

---
# Reconciler Manager Deployment
# This manages the lifecycle of reconcilers (one per RootSync)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reconciler-manager
  namespace: config-management-system
  labels:
    configmanagement.gke.io/system: "true"
    configmanagement.gke.io/arch: "csmr"
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: reconciler-manager
      configmanagement.gke.io/system: "true"
      configmanagement.gke.io/arch: "csmr"
  template:
    metadata:
      labels:
        app: reconciler-manager
        configmanagement.gke.io/system: "true"
        configmanagement.gke.io/arch: "csmr"
    spec:
      serviceAccountName: root-reconciler
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: reconciler-manager
          image: gcr.io/config-management-release/reconciler-manager:v1.17.2
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 100m
              memory: 200Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          env:
            - name: RECONCILER_MANAGER_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5

---
# Config Management Operator Deployment
# This watches for ConfigManagement and RootSync CRs
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-management-operator
  namespace: config-management-system
  labels:
    configmanagement.gke.io/system: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-management-operator
      configmanagement.gke.io/system: "true"
  template:
    metadata:
      labels:
        app: config-management-operator
        configmanagement.gke.io/system: "true"
    spec:
      serviceAccountName: root-reconciler
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: config-management-operator
          image: gcr.io/config-management-release/config-management-operator:v1.17.2
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 100m
              memory: 200Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10

---
# RootSync CRD - defines what a RootSync resource looks like
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: rootsyncs.configsync.gke.io
  labels:
    configmanagement.gke.io/system: "true"
spec:
  group: configsync.gke.io
  names:
    kind: RootSync
    listKind: RootSyncList
    plural: rootsyncs
    singular: rootsync
    shortNames:
      - rs
  scope: Namespaced
  versions:
    - name: v1beta1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - sourceFormat
              properties:
                sourceFormat:
                  type: string
                  enum:
                    - hierarchy
                    - unstructured
                  description: Format of the source repository
                git:
                  type: object
                  required:
                    - repo
                    - branch
                  properties:
                    repo:
                      type: string
                      description: Git repository URL
                    branch:
                      type: string
                      description: Git branch to sync
                    dir:
                      type: string
                      description: Directory within repo to sync
                      default: "/"
                    revision:
                      type: string
                      description: Git revision (commit SHA, tag)
                    auth:
                      type: string
                      enum:
                        - ssh
                        - cookiefile
                        - token
                        - gcenode
                        - gcpserviceaccount
                        - none
                      default: none
                      description: Authentication method
                    secretRef:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Name of secret containing credentials
                      description: Reference to secret for git authentication
                    period:
                      type: string
                      default: "15s"
                      description: How often to check for changes
                    noSSLVerify:
                      type: boolean
                      default: false
                      description: Skip SSL verification
            status:
              type: object
              x-kubernetes-preserve-unknown-fields: true
              description: Status of the RootSync
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: RenderingCommit
          type: string
          jsonPath: .status.rendering.commit
        - name: SourceCommit
          type: string
          jsonPath: .status.source.commit
        - name: SyncCommit
          type: string
          jsonPath: .status.sync.commit
        - name: Status
          type: string
          jsonPath: .status.sync.lastUpdate

---
# ConfigManagement CRD (optional, for legacy support)
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: configmanagements.configmanagement.gke.io
  labels:
    configmanagement.gke.io/system: "true"
spec:
  group: configmanagement.gke.io
  names:
    kind: ConfigManagement
    listKind: ConfigManagementList
    plural: configmanagements
    singular: configmanagement
  scope: Cluster
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              x-kubernetes-preserve-unknown-fields: true
            status:
              type: object
              x-kubernetes-preserve-unknown-fields: true

---
# OPTIONAL: Git credentials secret (only if using private repos)
# This secret should be created if git.auth is set to "token" or "ssh"

# For token authentication (HTTPS with Personal Access Token):
# apiVersion: v1
# kind: Secret
# metadata:
#   name: git-creds # kpt-set: ${cluster-name}-git-creds
#   namespace: config-management-system
# type: kubernetes.io/basic-auth
# stringData:
#   username: YOUR_GITHUB_USERNAME
#   password: YOUR_GITHUB_TOKEN  # Personal Access Token with 'repo' scope

# For SSH authentication:
# apiVersion: v1
# kind: Secret
# metadata:
#   name: git-creds # kpt-set: ${cluster-name}-git-creds
#   namespace: config-management-system
# type: kubernetes.io/ssh-auth
# data:
#   ssh: <base64-encoded-ssh-private-key>


#==============================================================================
# USAGE INSTRUCTIONS
#==============================================================================

# These files work together:
# 1. configsync.yaml installs ConfigSync on the cluster
# 2. rootsync.yaml tells ConfigSync which repo to watch

# IMPORTANT: These must be applied MANUALLY to bootstrap the cluster
# (This is the one-time manual step per cluster)

# On my-ran cluster:
#   kubectl config use-context my-ran
#   kubectl apply -f configsync.yaml
#   # Wait for ConfigSync pods to be ready
#   kubectl wait --for=condition=Ready pod -l app=reconciler-manager \
#     -n config-management-system --timeout=300s
#   kubectl apply -f rootsync.yaml

# On my-core cluster:
#   kubectl config use-context my-core
#   kubectl apply -f configsync.yaml
#   kubectl wait --for=condition=Ready pod -l app=reconciler-manager \
#     -n config-management-system --timeout=300s
#   kubectl apply -f rootsync.yaml

# After this, ConfigSync will automatically:
# 1. Clone the git repository
# 2. Watch for changes every 15 seconds
# 3. Apply any YAML files it finds
# 4. Reconcile drift (if someone manually changes something)

# Verify ConfigSync is working:
#   kubectl get rootsync -n config-management-system
#   kubectl describe rootsync root-sync -n config-management-system
#   kubectl get pods -n config-management-system

# Check sync status:
#   kubectl get rootsync root-sync -n config-management-system -o yaml

# Expected status when synced:
#   status:
#     sync:
#       commit: abc123...
#       lastUpdate: "2024-01-27T10:30:00Z"
#       status: "SYNCED"


#==============================================================================
# KPT SETTERS
#==============================================================================

# When Porch renders this package, it will replace these values:
# - ${cluster-repo-url} → https://github.com/YOUR-ORG/nephio-my-ran.git
# - ${cluster-repo-branch} → main
# - ${cluster-name} → my-ran or my-core

# This is configured in the PackageVariant:
#   pipeline:
#     mutators:
#       - image: gcr.io/kpt-fn/apply-setters:v0.2
#         configMap:
#           cluster-repo-url: https://github.com/YOUR-ORG/nephio-my-ran.git
#           cluster-repo-branch: main
#           cluster-name: my-ran


#==============================================================================
# TROUBLESHOOTING
#==============================================================================

# Issue: ConfigSync pods not starting
# Check:
#   kubectl get pods -n config-management-system
#   kubectl logs -n config-management-system deployment/reconciler-manager
# Solution: Ensure images are accessible, check RBAC

# Issue: RootSync shows "ERROR" status
# Check:
#   kubectl describe rootsync root-sync -n config-management-system
# Common causes:
#   - Git repo doesn't exist or URL is wrong
#   - Branch doesn't exist
#   - Authentication failed (for private repos)
#   - Network connectivity issues
# Solution: Fix the repo URL or add authentication

# Issue: RootSync not syncing
# Check:
#   kubectl get rootsync root-sync -n config-management-system -o yaml
#   kubectl logs -n config-management-system -l app=root-reconciler
# Solution: Check git repo accessibility, verify branch exists

# Issue: Changes in git not appearing in cluster
# Check:
#   kubectl get rootsync root-sync -n config-management-system
#   # Look at sync.commit and compare with git repo
# Solution: 
#   - Wait up to 15 seconds (period setting)
#   - Check reconciler logs for errors
#   - Verify YAML syntax in git repo

# Issue: "authentication required" error
# Solution: Create git-creds secret and reference in rootsync.yaml:
#   secretRef:
#     name: git-creds


#==============================================================================
# ALTERNATIVE: Using OCI Images (Advanced)
#==============================================================================

# ConfigSync can also sync from OCI registries instead of git:
# apiVersion: configsync.gke.io/v1beta1
# kind: RootSync
# metadata:
#   name: root-sync
#   namespace: config-management-system
# spec:
#   sourceFormat: unstructured
#   oci:
#     image: us-docker.pkg.dev/YOUR-PROJECT/YOUR-REPO/config:latest
#     auth: gcpserviceaccount
#     gcpServiceAccountEmail: config-sync@PROJECT.iam.gserviceaccount.com


#==============================================================================
# PRODUCTION CONSIDERATIONS
#==============================================================================

# 1. Resource Limits
# Adjust based on cluster size and number of resources:
#   resources:
#     requests:
#       cpu: 200m    # Increase for large clusters
#       memory: 500Mi
#     limits:
#       cpu: 2000m
#       memory: 2Gi

# 2. High Availability
# For production, consider multiple replicas:
#   replicas: 2  # In reconciler-manager deployment

# 3. Monitoring
# ConfigSync exposes metrics on port 8080:
#   kubectl port-forward -n config-management-system deployment/reconciler-manager 8080:8080
#   curl localhost:8080/metrics

# 4. Git Repository Best Practices
# - Use a dedicated branch for each cluster
# - Enable branch protection
# - Require PR reviews for changes
# - Use signed commits
# - Set up CI/CD to validate YAML before merge

# 5. Security
# - Use private repositories for sensitive configurations
# - Rotate git credentials regularly
# - Use SSH keys instead of tokens where possible
# - Enable audit logging on git repository

# 6. Backup and Disaster Recovery
# - Git repository IS your backup (declarative config)
# - To restore a cluster: redeploy ConfigSync + RootSync
# - ConfigSync will sync all resources from git
# - No need for etcd backups if using GitOps properly
